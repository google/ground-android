# Copyright 2024 The Ground Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: End to End Test Dispatchers

on:
    workflow_dispatch:

jobs:
    submitTest:
        name: Submit to survey
        runs-on: ubuntu-latest
        strategy:
          matrix:
            api-level: [24]
        steps:
          - name: Delete unnecessary tools ðŸ”§
            uses: jlumbroso/free-disk-space@v1.3.1
            with:
              android: false # Don't remove Android tools
              tool-cache: true # Remove image tool cache - rm -rf "$AGENT_TOOLSDIRECTORY"
              dotnet: true # rm -rf /usr/share/dotnet
              haskell: true # rm -rf /opt/ghc...
              swap-storage: true # rm -f /mnt/swapfile (4GiB)
              docker-images: true # Takes 16s, enable if needed in the future
              large-packages: true # includes google-cloud-sdk and it's slow

          - name: Enable KVM group perms
            run: |
              echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
              sudo udevadm control --reload-rules
              sudo udevadm trigger --name-match=kvm
              ls /dev/kvm

          - name: Gradle cache
            uses: gradle/actions/setup-gradle@v3

          - name: AVD cache
            uses: actions/cache@v4
            id: avd-cache
            with:
              path: |
                ~/.android/avd/*
                ~/.android/adb*
              key: avd-${{ matrix.api-level }}

          - name: Checkout
            uses: actions/checkout@v4

          - name: Copy CI gradle.properties
            run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

          - name: Set up JDK 17
            uses: actions/setup-java@v4
            with:
              distribution: 'zulu'
              java-version: 17

          - name: Setup Gradle
            uses: gradle/gradle-build-action@v3

          - name: Checkout ground-platform
            uses: actions/checkout@v4
            with:
              repository: sufyanAbbasi/ground-platform
              path: ground-platform

          - name: Copy Firebase emulator data
            uses: actions/download-artifact@v4
            with:
              name: data-test
              path: data

          - name: Set up Node.js 18
            uses: actions/setup-node@v4
            with:
              node-version: 18
          - name: Install firebase-tools
            run: |
              npm install -g firebase-tools

          - name: Build projects and run instrumentation tests
            uses: reactivecircus/android-emulator-runner@v2
            with:
              api-level: ${{ matrix.api-level }}
              force-avd-creation: false
              emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back emulated
              disable-animations: true
              script: firebase emulators:exec './gradlew :e2eTest:connectedLocalDebugAndroidTest' --config ground-platform/firebase.local.json --import data/test --export-on-exit data/test

          - name: Upload test reports
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: test-reports-${{ matrix.api-level }}
              path: '**/build/reports/androidTests'

          - name: Store data/test
            uses: actions/upload-artifact@v4
            with:
              name: data-test
              path: data
              retention-days: 1
              overwrite: true