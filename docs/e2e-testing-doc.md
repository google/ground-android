# End-to-End (E2E) testing on Android

## Current setup

The Android E2E tests rely on a predefined test survey created by the web application and stored in
the Firebase emulator data

### 1. Predefined test survey

The test data was originally generated by running the web application locally against the Firebase
emulator and exporting the emulator state. This ensures a consistent starting state for tests

### 2. Test Execution Flow

The CI workflow (and local execution) follows these steps:

1. **Start Firebase Emulator**: Loads the predefined data
2. **Run Tests**: Executes Android instrumentation tests in the `e2eTest` module against the
   emulator

## Managing test data and local testing

### Running tests locally
1. Clone `ground-platform` and set up the project according to the [documentation](https://github.com/google/ground-platform)
2. Run the following command to launch the local Firebase emulator with test data:
   ```bash
   # From the ground-platform directory
   nx start-android-test-data
   ```
3. Run all tests on `e2eTest` module using the `localDebug` build variant

### Updating test data
Since the Android app relies on specific survey structures, changes to the survey schema may require
updating the test data. Follow the steps in "Running tests locally" above, then:
1. Manually set up or update the survey (via the web UI) to match the scenarios expected by the Android `e2eTest` module.
2. Verify that all tests pass locally using the `localDebug` build variant
3. Export the updated emulator data to persist changes:
   ```bash
   firebase emulators:export data/test-android --project demo-local
   ```
   *Note: This overwrites the data in `data/test-android`.*

## Limitations

This setup does not fully prevent data drift between the web and Android apps. Any structural
changes in surveys require manual updates to the predefined test data.

This could be improved by implementing web E2E tests that generate Firestore test data on each run
and trigger the Android E2E tests. Optionally, the web tests could also verify the final persisted
state.